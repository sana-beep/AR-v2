<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR - Sensor Test</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            overflow: hidden;
            position: relative;
        }

        /* AR Scene - Full Screen */
        .a-canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1;
        }

        /* Status Panel - Fixed Position */
        .status-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            max-height: 120px;
            overflow-y: auto;
        }

        .status-panel h3 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
        }

        .status-item {
            background: rgba(0, 255, 0, 0.1);
            padding: 5px;
            border-radius: 4px;
        }

        /* Control Panel - Fixed Position */
        .control-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
        }

        .control-panel h3 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
        }

        /* Joystick Container */
        .joystick-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .joystick-group {
            text-align: center;
        }

        .joystick-group h4 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .joystick {
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            border-radius: 50%;
            margin: 0 auto;
            position: relative;
            cursor: pointer;
            touch-action: none;
        }

        .joystick-knob {
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Slider Container */
        .slider-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .slider-group {
            text-align: center;
        }

        .slider-group h4 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(0, 255, 0, 0.3);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            touch-action: none;
        }

        .slider-thumb {
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            touch-action: none;
        }

        .slider-value {
            margin-top: 5px;
            font-size: 12px;
            color: #00ff00;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .action-btn {
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .action-btn:hover {
            background: #00ff00;
            color: #000;
        }

        /* AR Content Status */
        .ar-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            z-index: 999;
            font-size: 18px;
            min-width: 200px;
        }

        .ar-status.visible {
            border-color: #00ff00;
            color: #00ff00;
        }

        .ar-status.hidden {
            border-color: #ff0000;
            color: #ff0000;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .status-panel, .control-panel {
                padding: 10px;
                margin: 5px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .joystick-container, .slider-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .joystick {
                width: 60px;
                height: 60px;
            }
            
            .joystick-knob {
                width: 16px;
                height: 16px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Hide AR.js stats */
        .a-enter-vr, .a-orientation-modal {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        style="position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;">
        
        <!-- Camera -->
        <a-entity camera></a-entity>
        
        <!-- AR Content - 3D Box -->
        <a-box 
            id="ar-content"
            position="0 0 -1"
            rotation="0 0 0"
            scale="0.5 0.5 0.5"
            material="src: testimg.jpg;"
            visible="false"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 5000">
        </a-box>
        
        <!-- AR.js Marker -->
        <a-marker preset="hiro">
            <a-box position="0 0.5 0" material="color: yellow;"></a-box>
        </a-marker>
    </a-scene>

    <!-- Status Panel -->
    <div class="status-panel">
        <h3>üìä SENSOR STATUS</h3>
        <div class="status-grid">
            <div class="status-item">
                <strong>üß≠ Compass:</strong> <span id="compass-value">--</span>¬∞
            </div>
            <div class="status-item">
                <strong>‚ö° Accelerometer Y:</strong> <span id="accel-y-value">--</span>
            </div>
            <div class="status-item">
                <strong>üéØ AR Status:</strong> <span id="ar-status-text">HIDDEN</span>
            </div>
            <div class="status-item">
                <strong>üìç GPS:</strong> <span id="gps-value">--</span>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <h3>üéÆ 3D OBJECT CONTROLS</h3>
        
        <!-- Joysticks for Position -->
        <div class="joystick-container">
            <div class="joystick-group">
                <h4>X Position</h4>
                <div class="joystick" id="joystick-x" data-axis="x">
                    <div class="joystick-knob" id="knob-x"></div>
                </div>
            </div>
            <div class="joystick-group">
                <h4>Y Position</h4>
                <div class="joystick" id="joystick-y" data-axis="y">
                    <div class="joystick-knob" id="knob-y"></div>
                </div>
            </div>
            <div class="joystick-group">
                <h4>Z Position</h4>
                <div class="joystick" id="joystick-z" data-axis="z">
                    <div class="joystick-knob" id="knob-z"></div>
                </div>
            </div>
        </div>

        <!-- Sliders for Scale -->
        <div class="slider-container">
            <div class="slider-group">
                <h4>Scale X</h4>
                <div class="slider" id="slider-scale-x" data-axis="x">
                    <div class="slider-thumb" id="thumb-scale-x"></div>
                </div>
                <div class="slider-value" id="value-scale-x">1.0</div>
            </div>
            <div class="slider-group">
                <h4>Scale Y</h4>
                <div class="slider" id="slider-scale-y" data-axis="y">
                    <div class="slider-thumb" id="thumb-scale-y"></div>
                </div>
                <div class="slider-value" id="value-scale-y">1.0</div>
            </div>
            <div class="slider-group">
                <h4>Scale Z</h4>
                <div class="slider" id="slider-scale-z" data-axis="z">
                    <div class="slider-thumb" id="thumb-scale-z"></div>
                </div>
                <div class="slider-value" id="value-scale-z">1.0</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn" onclick="resetObject()">üîÑ Reset</button>
            <button class="action-btn" onclick="goBack()">üè† Back to Main</button>
        </div>
    </div>

    <!-- AR Content Status -->
    <div class="ar-status hidden" id="ar-status">
        <div>üéØ AR CONTENT</div>
        <div id="ar-status-text">HIDDEN</div>
    </div>

    <script>
        // Global variables
        let compassValue = 0;
        let accelerometerY = 0;
        let isARVisible = false;
        let isDragging = false;
        let currentJoystick = null;
        let currentSlider = null;

        // Object transformation values
        let objectTransform = {
            position: { x: 0, y: 0, z: -1 },
            scale: { x: 0.5, y: 0.5, z: 0.5 }
        };

        // DOM elements
        const arContent = document.getElementById('ar-content');
        const arStatus = document.getElementById('ar-status');
        const arStatusText = document.getElementById('ar-status-text');
        const compassValueEl = document.getElementById('compass-value');
        const accelYValueEl = document.getElementById('accel-y-value');
        const gpsValueEl = document.getElementById('gps-value');

        // Initialize sensors
        function initSensors() {
            // Initialize device orientation (compass)
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (event) => {
                    let compass = event.alpha;
                    
                    // Handle iOS vs Android differences
                    if (compass === null) {
                        compass = event.webkitCompassHeading || 0;
                    }
                    
                    // Normalize to 0-360
                    compass = (compass + 360) % 360;
                    compassValue = compass;
                    compassValueEl.textContent = Math.round(compass);
                    
                    // Check AR visibility
                    checkARVisibility();
                });
            }

            // Initialize accelerometer
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const accel = event.accelerationIncludingGravity;
                    if (accel) {
                        accelerometerY = accel.y;
                        accelYValueEl.textContent = Math.round(accel.y);
                        
                        // Check AR visibility
                        checkARVisibility();
                    }
                });
            }

            // Initialize GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);
                        gpsValueEl.textContent = `${lat}, ${lon}`;
                    },
                    (error) => {
                        gpsValueEl.textContent = 'Error';
                    }
                );
            }
        }

        // Check AR visibility based on sensor conditions
        function checkARVisibility() {
            const compassInRange = compassValue >= 100 && compassValue <= 150;
            const accelInRange = accelerometerY > 5;
            
            const shouldBeVisible = compassInRange && accelInRange;
            
            if (shouldBeVisible && !isARVisible) {
                showARContent();
            } else if (!shouldBeVisible && isARVisible) {
                hideARContent();
            }
        }

        // Show AR content
        function showARContent() {
            isARVisible = true;
            arContent.setAttribute('visible', true);
            arStatus.className = 'ar-status visible';
            arStatusText.textContent = 'VISIBLE';
        }

        // Hide AR content
        function hideARContent() {
            isARVisible = false;
            arContent.setAttribute('visible', false);
            arStatus.className = 'ar-status hidden';
            arStatusText.textContent = 'HIDDEN';
        }

        // Initialize joysticks
        function initJoysticks() {
            const joysticks = document.querySelectorAll('.joystick');
            
            joysticks.forEach(joystick => {
                joystick.addEventListener('mousedown', startJoystickDrag);
                joystick.addEventListener('touchstart', startJoystickDrag);
                joystick.addEventListener('mousemove', joystickDrag);
                joystick.addEventListener('touchmove', joystickDrag);
                joystick.addEventListener('mouseup', stopJoystickDrag);
                joystick.addEventListener('touchend', stopJoystickDrag);
            });
        }

        // Initialize sliders
        function initSliders() {
            const sliders = document.querySelectorAll('.slider');
            
            sliders.forEach(slider => {
                slider.addEventListener('mousedown', startSliderDrag);
                slider.addEventListener('touchstart', startSliderDrag);
                slider.addEventListener('mousemove', sliderDrag);
                slider.addEventListener('touchmove', sliderDrag);
                slider.addEventListener('mouseup', stopSliderDrag);
                slider.addEventListener('touchend', stopSliderDrag);
            });
        }

        // Joystick drag functions
        function startJoystickDrag(event) {
            event.preventDefault();
            isDragging = true;
            currentJoystick = event.currentTarget;
            currentJoystick.style.background = 'rgba(0, 255, 0, 0.3)';
        }

        function joystickDrag(event) {
            if (!isDragging || !currentJoystick) return;
            
            event.preventDefault();
            const rect = currentJoystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let clientX, clientY;
            if (event.type.includes('touch')) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            
            const deltaX = (clientX - centerX) / (rect.width / 2);
            const deltaY = (clientY - centerY) / (rect.height / 2);
            
            // Limit to circle
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            if (distance > 1) {
                const scale = 1 / distance;
                deltaX *= scale;
                deltaY *= scale;
            }
            
            // Update knob position
            const knob = currentJoystick.querySelector('.joystick-knob');
            knob.style.left = `${50 + deltaX * 50}%`;
            knob.style.top = `${50 + deltaY * 50}%`;
            
            // Update object position
            const axis = currentJoystick.dataset.axis;
            objectTransform.position[axis] = deltaX * 2; // Scale factor
            
            // Apply transformation
            applyObjectTransform();
        }

        function stopJoystickDrag() {
            if (currentJoystick) {
                currentJoystick.style.background = 'rgba(0, 255, 0, 0.1)';
                currentJoystick = null;
            }
            isDragging = false;
        }

        // Slider drag functions
        function startSliderDrag(event) {
            event.preventDefault();
            isDragging = true;
            currentSlider = event.currentTarget;
        }

        function sliderDrag(event) {
            if (!isDragging || !currentSlider) return;
            
            event.preventDefault();
            const rect = currentSlider.getBoundingClientRect();
            let clientX;
            
            if (event.type.includes('touch')) {
                clientX = event.touches[0].clientX;
            } else {
                clientX = event.clientX;
            }
            
            const percentage = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            
            // Update thumb position
            const thumb = currentSlider.querySelector('.slider-thumb');
            thumb.style.left = `${percentage * 100}%`;
            
            // Update value display
            const valueEl = currentSlider.parentElement.querySelector('.slider-value');
            const value = (percentage * 2 + 0.1).toFixed(1); // Range: 0.1 to 2.1
            valueEl.textContent = value;
            
            // Update object scale
            const axis = currentSlider.dataset.axis;
            objectTransform.scale[axis] = parseFloat(value);
            
            // Apply transformation
            applyObjectTransform();
        }

        function stopSliderDrag() {
            currentSlider = null;
            isDragging = false;
        }

        // Apply object transformation
        function applyObjectTransform() {
            if (arContent) {
                arContent.setAttribute('position', 
                    `${objectTransform.position.x} ${objectTransform.position.y} ${objectTransform.position.z}`);
                arContent.setAttribute('scale', 
                    `${objectTransform.scale.x} ${objectTransform.scale.y} ${objectTransform.scale.z}`);
            }
        }

        // Reset object to default
        function resetObject() {
            objectTransform = {
                position: { x: 0, y: 0, z: -1 },
                scale: { x: 0.5, y: 0.5, z: 0.5 }
            };
            
            // Reset joysticks
            document.querySelectorAll('.joystick-knob').forEach(knob => {
                knob.style.left = '50%';
                knob.style.top = '50%';
            });
            
            // Reset sliders
            document.querySelectorAll('.slider-thumb').forEach((thumb, index) => {
                thumb.style.left = '50%';
            });
            
            document.querySelectorAll('.slider-value').forEach((valueEl, index) => {
                valueEl.textContent = '1.0';
            });
            
            // Apply transformation
            applyObjectTransform();
        }

        // Go back to main page
        function goBack() {
            window.location.href = 'index.html';
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            initSensors();
            initJoysticks();
            initSliders();
            
            // Hide AR status after 3 seconds
            setTimeout(() => {
                arStatus.style.opacity = '0.7';
            }, 3000);
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page is visible again, refresh sensors
                initSensors();
            }
        });
    </script>
</body>
</html>
